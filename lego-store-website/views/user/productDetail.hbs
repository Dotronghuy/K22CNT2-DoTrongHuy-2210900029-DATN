<style>
    .product-info-tabs {
        border-top: 1px solid #eee;
        padding-top: 30px;

        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 24px;
    }

    .tabs-nav {
        display: flex;
        gap: 30px;
        border-bottom: 2px solid #f0f0f0;
        margin-bottom: 30px;
    }

    .tab-link {
        background: none;
        border: none;
        padding: 15px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
    }

    .tab-link:hover {
        color: #df2020;
    }

    .tab-link.active {
        color: #df2020;
    }

    .tab-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: #df2020;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.4s ease;
        min-height: 200px;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Table Styles */
    .info-table {
        width: 100%;
        max-width: 800px;
        border-collapse: collapse;
        font-size: 0.95rem;
        border: 1px solid #eaeaea;
    }

    .info-table tr {
        border-bottom: 1px solid #eaeaea;
    }

    .info-table td {
        padding: 15px;
        border-right: 1px solid #f0f0f0;
    }

    .info-table td:first-child {
        font-weight: 600;
        color: #333;
        width: 30%;
        background-color: #fafafa;
    }

    .info-table td:last-child {
        color: #666;
    }

    /* Description Styles */
    .description-text {
        max-width: 900px;
        line-height: 1.8;
        color: #444;
    }

    /* Usage Styles */
    .usage-list {
        list-style: none;
        padding: 0;
        max-width: 800px;
    }

    .usage-list li {
        padding: 10px 0;
        color: #555;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .usage-list li i {
        color: #28a745;
        font-size: 1.2rem;
    }
</style>

{{#> _wrappers/user-wrapper}}

<main class="container section product-detail-page">
    <div class="detail-layout">
        <div>
            <div class="gallery-main">
                <button class="gallery-btn prev" id="prevImage">‹</button>
                <img id="mainProductImage" src="{{product.images.[0]}}" alt="RX-93 Nu Gundam">
                <button class="gallery-btn next" id="nextImage">›</button>
            </div>
            <div class="thumbs thumbnail-images">
                {{#each product.images}}
                <img class="thumbnail" src="{{this}}" alt="thumb">
                {{/each}}
            </div>
        </div>
        <div class="detail-info">

            <h1>{{product.name}}</h1>
            Danh mục: <p class="tag">{{product.categoryId.name}}</p>

            Thương hiệu: <p class="tag">{{product.brandId.name}}</p>
            <div id="variant-container">

            </div>

            <h2 class="product-price">{{formatCurrency product.price}}</h2>

            <div class="quantity-container" style="display: flex; gap: 16px;align-items: center;">

                <div class="quantity-selector">
                    <button id="decreaseQty">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                    <input type="number" id="productQty" value="1" min="1">
                    <button id="increaseQty">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>

                <div class="cta-row" style="width: 100%;margin: 0;">
                    <a style="width: 100%;" id="addToCart" data-id="{{product._id}}" class="btn primary"><i
                            class="bi bi-cart"></i>Thêm vào
                        giỏ
                        hàng</a>
                </div>
            </div>


            {{!-- <div class="trust-badge_div">
                <div class="trust-badge_container">
                    <div class="trust-badge_card">
                        <img class="trust-badge_img" src="/images/trust-badge-1.webp" width="240" height="260">
                        <span class="trust-badge_heading">

                            Sản phẩm <span style="white-space: nowrap;">chính hãng 100%</span>

                        </span>
                    </div>
                    <div class="trust-badge_card">
                        <img class="trust-badge_img" src="/images/trust-badge-2.webp" width="240" height="260">
                        <span class="trust-badge_heading">

                            Chất liệu an toàn <span style="white-space: nowrap;">cho trẻ em</span>

                        </span>
                    </div>
                </div>
            </div> --}}
        </div>
</main>

<div class="container section">
    <div class="product-info-tabs">
        <div class="tabs-nav">
            <button class="tab-link active" onclick="openTab(event, 'tab-info')">Thông tin sản phẩm</button>
            <button class="tab-link" onclick="openTab(event, 'tab-desc')">Mô tả sản phẩm</button>
            <button class="tab-link" onclick="openTab(event, 'tab-usage')">Công dụng</button>
        </div>

        <div id="tab-info" class="tab-content active">
            <table class="info-table">
                <tr>
                    <td>Thương hiệu</td>
                    <td>{{product.brandId.name}}</td>
                </tr>
                <tr>
                    <td>Danh mục</td>
                    <td>{{product.categoryId.name}}</td>
                </tr>
                {{!-- <tr>
                    <td>Chất liệu</td>
                    <td>Nhựa ABS cao cấp, an toàn</td>
                </tr>
                <tr>
                    <td>Độ tuổi phù hợp</td>
                    <td>6+</td>
                </tr>
                <tr>
                    <td>Kích thước hộp</td>
                    <td>30 x 20 x 5 cm</td>
                </tr> --}}
            </table>
        </div>

        <div id="tab-desc" class="tab-content">
            <div class="description-text">
                <ul>
                    {{#if product.productInfo}}
                    {{#each (splitLines product.productInfo) }}
                    <li>• {{this}}</li>
                    {{/each}}
                    {{else}}
                    <li>• Hiện chưa có thông tin</li>
                    {{/if}}
                </ul>
            </div>
        </div>

        <div id="tab-usage" class="tab-content">
            <ul class="usage-list">
                {{#if product.usage}}
                {{#each (splitLines product.usage)}}
                <li><i class="bi bi-check2-circle"></i> {{this}}</li>
                {{/each}}
                {{else}}
                <li>Chưa có thông tin về công dụng sản phẩm.</li>
                {{/if}}
            </ul>
        </div>
    </div>
</div>

<main class="container section" style="border-top: 1px solid #eee;">
    <section class="section review-section">
        <div class="section-header">
            <div>
                <p class="eyebrow">Nhận xét</p>
                <h2>Đánh giá sản phẩm</h2>
            </div>
            <div class="right">
                {{!-- {{#if totalReviews}}
                <div class="rating-average">
                    <div class="average-number">{{averageRating}}</div>
                    <div class="rating-group">
                        <div class="rating-stars">
                            {{#each (range 1 5)}}
                            <i class="bi {{#if (lte this ../averageRating)}}bi-star-fill{{else}}bi-star{{/if}}"></i>
                            {{/each}}
                        </div>
                        <div class="total-reviews">
                            Đánh giá bởi ({{totalReviews}} người)
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="no-reviews">
                    Chưa có đánh giá nào
                </div>
                {{/if}} --}}

                {{!-- {{#if totalReviews}} --}}
                <div class="rating-average">
                    <div class="average-number">{{averageRating}}</div>
                    <div class="rating-group">
                        <div class="rating-stars">
                            {{#each (range 1 5)}}
                            <i class="bi {{#if (lte this ../averageRating)}}bi-star-fill{{else}}bi-star{{/if}}"></i>
                            {{/each}}
                        </div>
                        <div class="total-reviews">
                            {{totalReviews}} lượt đánh giá
                        </div>
                    </div>
                </div>
                {{!-- {{else}}
                <div class="no-reviews">
                    Chưa có đánh giá nào
                </div>
                {{/if}} --}}

            </div>
        </div>
        {{#if reviews.length}}
        <div class="reviews-grid">
            {{#each reviews}}
            <div class="review-card">
                <div class="review-header">
                    <div class="review-user-info">
                        <img src="{{this.userId.avatarUrl}}" alt="{{this.userId.fullName}}" class="review-avatar">
                        <div class="user-details">
                            <strong>{{this.userId.fullName}}</strong>
                            <div class="rating-stars">
                                {{#each (range 1 5)}}
                                <i class="bi {{#if (lte this ../rating)}}bi-star-fill{{else}}bi-star{{/if}}"></i>
                                {{/each}}
                            </div>
                        </div>
                    </div>
                    <div class="review-date">
                        <p>Ngày đăng</p>
                        <small>{{formatDate this.createdAt}}</small>
                    </div>
                </div>

                <hr>

                <div class="review-body">

                    {{#if this.images.length}}
                    <div class="review-images">
                        {{#each this.images}}
                        <img src="{{this}}" class="review-image" alt="review image">
                        {{/each}}
                    </div>
                    {{/if}}
                    <p class="comment">{{this.comment}}</p>

                </div>
            </div>
            {{/each}}

        </div>
        {{else}}
        <p class="text-center text-muted" style="text-align: center;">
            Chưa có đánh giá nào, hãy chia sẻ đánh giá của bạn cho sản phẩm này bạn nhé.
        </p>
        {{/if}}
    </section>
</main>

<script>
    const PRODUCT = {{{ json product }}};

    let selectedVariants = {};
    let currentCombination = null;
    const productPrice = document.querySelector('.product-price');
    window.matchingCombo = PRODUCT.hasVariants ? PRODUCT.variantCombinations[0] : null

    function initializeVariants() {
        if (!PRODUCT.hasVariants || !PRODUCT.variants || PRODUCT.variants.length === 0) {
            return;
        }

        renderVariants();
    }

    function getAvailableOptions(variantId, variantIndex) {
        const availableOptions = new Set();

        PRODUCT.variantCombinations.forEach(combo => {
            if (variantIndex === 0) {
                const variantInCombo = combo.variants.find(v => v.variantId === variantId);
                if (variantInCombo) {
                    availableOptions.add(variantInCombo.value);
                }
            } else {
                const matchPrevious = checkPreviousSelections(combo, variantIndex);

                if (matchPrevious) {
                    const variantInCombo = combo.variants.find(v => v.variantId === variantId);
                    if (variantInCombo) {
                        availableOptions.add(variantInCombo.value);
                    }
                }
            }
        });

        return Array.from(availableOptions);
    }

    function checkPreviousSelections(combo, currentIndex) {
        for (let i = 0; i < currentIndex; i++) {
            const prevVariant = PRODUCT.variants[i];
            const selectedValue = selectedVariants[prevVariant._id];

            if (!selectedValue) {
                return false;
            }

            const matchInCombo = combo.variants.some(v =>
                v.variantId === prevVariant._id && v.value === selectedValue
            );

            if (!matchInCombo) {
                return false;
            }
        }
        return true;
    }

    function renderVariants() {
        const container = document.getElementById('variant-container');
        container.innerHTML = '';

        PRODUCT.variants.forEach((variant, index) => {
            const variantGroup = createVariantGroup(variant, index);
            container.appendChild(variantGroup);
        });

        if (PRODUCT.variants.length > 0) {
            const firstVariant = PRODUCT.variants[0];
            const availableOptions = getAvailableOptions(firstVariant._id, 0);
            if (availableOptions.length > 0) {
                selectVariantOption(firstVariant._id, availableOptions[0], 0);
            }
        }
    }

    function createVariantGroup(variant, variantIndex) {
        const group = document.createElement('div');
        group.className = 'variant-group';
        group.dataset.variantId = variant._id;
        group.dataset.variantIndex = variantIndex;

        const title = document.createElement('div');
        title.className = 'variant-title';
        title.textContent = variant.name + ":";
        group.appendChild(title);

        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'variant-options';

        const availableOptions = getAvailableOptions(variant._id, variantIndex);

        availableOptions.forEach(option => {
            const optionSpan = createVariantOption(variant._id, option, variantIndex);
            optionsContainer.appendChild(optionSpan);
        });

        group.appendChild(optionsContainer);
        return group;
    }

    function createVariantOption(variantId, option, variantIndex) {
        const span = document.createElement('span');
        span.className = 'variant-option';
        span.textContent = option;
        span.dataset.variantId = variantId;
        span.dataset.value = option;

        span.addEventListener('click', () => {
            selectVariantOption(variantId, option, variantIndex);
        });

        return span;
    }

    function selectVariantOption(variantId, option, variantIndex) {
        selectedVariants[variantId] = option;

        updateVariantGroupUI(variantId, option);
        resetSubsequentVariants(variantIndex);
        updateNextVariantOptions(variantIndex);
        updateProductInfo();
    }

    function updateVariantGroupUI(variantId, selectedOption) {
        const group = document.querySelector(`.variant-group[data-variant-id="${variantId}"]`);
        if (!group) return;

        const options = group.querySelectorAll('.variant-option');
        options.forEach(opt => {
            if (opt.dataset.value === selectedOption) {
                opt.classList.add('selected');
            } else {
                opt.classList.remove('selected');
            }
        });
    }

    function resetSubsequentVariants(currentIndex) {
        for (let i = currentIndex + 1; i < PRODUCT.variants.length; i++) {
            const variant = PRODUCT.variants[i];
            delete selectedVariants[variant._id];

            const group = document.querySelector(`.variant-group[data-variant-id="${variant._id}"]`);
            if (group) {
                const options = group.querySelectorAll('.variant-option');
                options.forEach(opt => opt.classList.remove('selected'));
            }
        }
    }
    function updateNextVariantOptions(currentIndex) {
        for (let i = currentIndex + 1; i < PRODUCT.variants.length; i++) {
            const variant = PRODUCT.variants[i];
            const group = document.querySelector(`.variant-group[data-variant-id="${variant._id}"]`);

            if (group) {
                const optionsContainer = group.querySelector('.variant-options');
                optionsContainer.innerHTML = '';

                const availableOptions = getAvailableOptions(variant._id, i);

                availableOptions.forEach(option => {
                    const optionSpan = createVariantOption(variant._id, option, i);
                    optionsContainer.appendChild(optionSpan);
                });

                if (availableOptions.length === 1) {
                    selectVariantOption(variant._id, availableOptions[0], i);
                }
            }
        }
    }

    function updateProductInfo() {
        const allSelected = PRODUCT.variants.every(v => selectedVariants[v._id]);

        if (!allSelected) {
            currentCombination = null;
            return;
        }

        const matchingCombo = PRODUCT.variantCombinations.find(combo => {
            return PRODUCT.variants.every(variant => {
                const selectedValue = selectedVariants[variant._id];
                return combo.variants.some(v =>
                    v.variantId === variant._id && v.value === selectedValue
                );
            });
        });

        if (matchingCombo) {
            currentCombination = matchingCombo;
            window.matchingCombo = matchingCombo;

            productPrice.innerText = formatPrice(matchingCombo.price);
            const event = new CustomEvent('variantSelected', {
                detail: {
                    combination: matchingCombo,
                    selectedVariants: selectedVariants
                }
            });
            document.dispatchEvent(event);

            updateProductDisplay(matchingCombo);
        } else {
            currentCombination = null;
        }
    }

    function updateProductDisplay(combination) {
        const priceElement = document.getElementById('product-price');
        if (priceElement) {
            priceElement.textContent = formatPrice(combination.price);
        }

        const stockElement = document.getElementById('product-stock');
        if (stockElement) {
            if (combination.stock > 0) {
                stockElement.textContent = `Còn ${combination.stock} sản phẩm`;
                stockElement.classList.remove('out-of-stock');
            } else {
                stockElement.textContent = 'Hết hàng';
                stockElement.classList.add('out-of-stock');
            }
        }

        if (combination.images && combination.images.length > 0) {
            const mainImage = document.getElementById('mainProductImage');
            const variantImageUrl = combination.images[0];
            const imageIndex = PRODUCT.images.findIndex(img => img === variantImageUrl);

            const thumbs = document.querySelectorAll('.thumbnail-images .thumbnail');
            thumbs[imageIndex]?.click();
        }
    }

    function formatPrice(price) {
        if (isNaN(price)) return '0₫';
        return Number(price).toLocaleString('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 0
        });
    }

    function openTab(evt, tabName) {
        var i, tabContent, tabLinks;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].classList.remove("active");
        }
        tabLinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tabLinks.length; i++) {
            tabLinks[i].classList.remove("active");
        }
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    if (document.readyState === 'loading') {

        document.addEventListener('DOMContentLoaded', initializeVariants);
    } else {
        initializeVariants();
    }
</script>
<script type="module" src="/javascripts/user/productDetail.module.js"></script>
{{/ _wrappers/user-wrapper}}